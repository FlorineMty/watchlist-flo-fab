<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>üé¨ Watchlist Authentifi√©e</title>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <style>
    body {
      font-family: sans-serif;
      background: #f8f6f3;
      margin: 0;
      padding: 0;
    }
    .watchlist-card {
  background: white;
  padding: 30px;
  border-radius: 12px;
  box-shadow: 0 5px 15px rgba(0,0,0,0.05);
  max-width: 800px;
  margin: 40px auto;
}
    .container {
      max-width: 700px;
      margin: 40px auto;
      padding: 20px;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      text-align: center;
    }
    form, select, textarea, input[type="text"] {
      margin-top: 10px;
      width: 100%;
      max-width: 500px;
      padding: 10px;
      font-size: 1rem;
    }
    .film-list {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
      margin-top: 20px;
    }
    .film {
  padding: 15px;
  background: #f9f8f6;
  border-radius: 8px;
  transition: transform 0.2s;
}
.film:hover {
  transform: translateY(-3px);
  box-shadow: 0 6px 12px rgba(0,0,0,0.06);
}
    }
    .film img {
      max-width: 100%;
      border-radius: 4px;
    }
    .hidden {
      display: none;
    }
    .readonly-note {
      font-size: 0.9rem;
      color: #888;
      margin-top: 10px;
    }
    .g_id_signin {
  border-radius: 12px !important;
  overflow: hidden;
  box-shadow: 0 2px 6px rgba(0,0,0,0.1);
  margin: 10px auto;
  width: fit-content;
}
  </style>
</head>
<body>

<div class="container" id="loginBox">
  <h2>Connexion √† la Watchlist</h2>
  <div id="g_id_onload"
    data-client_id="753185542113-ec8b0nlbtn4li698ljrfq8g6mpdccap4.apps.googleusercontent.com"
    data-context="signin"
    data-callback="handleCredentialResponse"
    data-auto_prompt="false">
  </div>
  <div class="g_id_signin"
    data-type="standard"
    data-size="large"
    data-theme="outline"
    data-text="sign_in_with"
    data-shape="rectangular"
    data-logo_alignment="left">
  </div>
  <p>ou</p>
  <button onclick="enterAsGuest()">Continuer en tant qu'invit√©</button>
</div>

<div class="container hidden" id="appBox">
  <h2>üé¨ Watchlist des Flammes Jum</h2>
  <p id="welcomeMessage"></p>
  <button onclick="logout()">Se d√©connecter</button>
  <div class="readonly-note" id="guestNote">Mode invit√© : lecture seule</div>

  <form id="filmForm">
    <input type="text" id="filmInput" placeholder="Titre du film..." required />
    <select id="addedBy" required>
      <option value="">Ajout√© par ?</option>
      <option value="Florine">Florine</option>
      <option value="Fabien">Fabien</option>
    </select>
    <textarea id="noteInput" placeholder="Note personnelle (facultatif)"></textarea>
    <button type="submit">Ajouter</button>
  </form>

  <select id="sortSelect">
    <option value="default">Tri par d√©faut</option>
    <option value="title">Titre</option>
    <option value="addedBy">Ajout√© par</option>
    <option value="watched">Vu / Non vu</option>
  </select>

  <div class="loader" id="loader">Chargement...</div>
  <div class="film-list" id="filmList"></div>
</div>

<script>
  let isGuest = false;
  const OMDB_API_KEY = 'd380a270';
  const ALLOWED_EMAILS = [
  "moutoussamy.florine@gmail.com",
  "fabien.ogli@gmail.com"
];
  let films = [];

function handleCredentialResponse(response) {
  const user = parseJwt(response.credential);
  console.log("Utilisateur connect√© :", user);
  if (user && user.email) {
    if (!ALLOWED_EMAILS.includes(user.email)) {
      alert("‚ö†Ô∏è Cet e-mail n‚Äôest pas autoris√© √† acc√©der √† cette application.");
      return;
    }
    localStorage.setItem("authUser", JSON.stringify(user));
    localStorage.setItem("isGuest", "0");
    showApp(user.name || "Utilisateur");
  }
}

  function parseJwt(token) {
    try {
      const base64Url = token.split('.')[1];
      const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
      const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
        return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
      }).join(''));
      return JSON.parse(jsonPayload);
    } catch (e) {
      return null;
    }
  }

  function enterAsGuest() {
    isGuest = true;
    localStorage.setItem("authUser", "guest");
    localStorage.setItem("isGuest", "1");
    showApp("Invit√©");
  }

  function logout() {
    localStorage.removeItem("authUser");
    localStorage.removeItem("isGuest");
    location.reload();
  }

function showApp(name) {
  document.getElementById("loginBox").classList.add("hidden");
  document.getElementById("appBox").classList.remove("hidden");
  document.getElementById("welcomeMessage").textContent = "Bienvenue, " + name + " !";

  const guest = localStorage.getItem("isGuest") === "1";
  isGuest = guest;
  document.getElementById("guestNote").style.display = guest ? "block" : "none";

  // Cacher les champs du formulaire si invit√©
  if (guest) {
    const formElements = document.querySelectorAll('#filmForm input, #filmForm select, #filmForm textarea, #filmForm button');
    formElements.forEach(el => el.style.display = 'none');
  }

  loadFromLocal();
  displayFilms();
}

  function saveToLocal() {
    localStorage.setItem("films", JSON.stringify(films));
  }

  function loadFromLocal() {
    const stored = localStorage.getItem("films");
    if (stored) films = JSON.parse(stored);
  }

  function displayFilms() {
    filmList.innerHTML = '';
    const sorted = [...films];
    switch (sortSelect.value) {
      case 'title': sorted.sort((a, b) => a.title.localeCompare(b.title)); break;
      case 'addedBy': sorted.sort((a, b) => a.addedBy.localeCompare(b.addedBy)); break;
      case 'watched': sorted.sort((a, b) => a.watched - b.watched); break;
    }

    sorted.forEach((film, index) => {
      const div = document.createElement('div');
      div.className = 'film';
      div.innerHTML = `
        ${film.poster ? `<img src="${film.poster}" alt="Affiche de ${film.title}" />` : ''}
        <p><strong>${film.title}</strong></p>
        <p>üé¨ R√©alis√© par : ${film.director || 'Inconnu'}</p>
        <p>üë§ Ajout√© par : ${film.addedBy}</p>
        ${film.note ? `<p>üìù ${film.note}</p>` : ''}
        ${!isGuest ? `
        <label><input type="checkbox" ${film.watched ? 'checked' : ''} onchange="toggleWatched(${index})" /> Vu</label>
        <button onclick="deleteFilm(${index})">Supprimer</button>` : ''}
      `;
      filmList.appendChild(div);
    });
  }

  function toggleWatched(index) {
    films[index].watched = !films[index].watched;
    saveToLocal();
    displayFilms();
  }

  function deleteFilm(index) {
    if (confirm('Supprimer ce film ?')) {
      films.splice(index, 1);
      saveToLocal();
      displayFilms();
    }
  }

  filmForm.addEventListener('submit', (e) => {
    e.preventDefault();
    if (isGuest) return;
    const title = filmInput.value.trim();
    const addedBy = addedBySelect.value;
    const note = noteInput.value.trim();
    if (title && addedBy) {
      loader.style.display = 'block';
      fetch(`https://www.omdbapi.com/?apikey=${OMDB_API_KEY}&t=${encodeURIComponent(title)}`)
        .then(res => res.json())
        .then(data => {
          const poster = data.Poster && data.Poster !== 'N/A' ? data.Poster : '';
          const director = data.Director && data.Director !== 'N/A' ? data.Director : 'Inconnu';
          films.push({ title, addedBy, watched: false, poster, director, note });
          saveToLocal();
          displayFilms();
          filmInput.value = '';
          noteInput.value = '';
          addedBySelect.value = '';
        })
        .catch(err => console.error(err))
        .finally(() => loader.style.display = 'none');
    }
  });

  sortSelect.addEventListener('change', displayFilms);

  window.onload = function () {
    const authUser = localStorage.getItem("authUser");
    const guest = localStorage.getItem("isGuest") === "1";
    if (authUser) {
      const name = guest ? "Invit√©" : JSON.parse(authUser).name || "Utilisateur";
      showApp(name);
    }
  }
</script>

</body>
</html>
