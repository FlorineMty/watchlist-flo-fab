
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üé¨ Watchlist Authentifi√©e</title>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <style>
    body {
      font-family: sans-serif;
      background: linear-gradient(135deg, #f8f6f3, #f2ede7);
      margin: 0;
      padding: 0 10px;
    }
    .film-form {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
      margin: 30px auto;
      width: 100%;
      max-width: 700px;
    }
    .film-form input,
    .film-form select,
    .film-form textarea {
      width: 100%;
      max-width: 100%;
      padding: 12px;
      font-size: 1rem;
      border-radius: 8px;
      border: 1px solid #ccc;
      box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.05);
    }
    .film-form button {
      align-self: flex-start;
      padding: 10px 20px;
    }
    button {
      background: #d5c5a4;
      color: #222;
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      transition: background 0.2s ease, transform 0.2s ease;
    }
    button:hover {
      background: #cbb897;
      transform: translateY(-2px);
    }
    .main-card {
      background: white;
      max-width: 800px;
      margin: 40px auto;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
    }
    .container {
      max-width: 700px;
      margin: 40px auto;
      padding: 20px;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      text-align: center;
    }
    .film-list {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
      margin-top: 20px;
    }
    .film {
      background: #faf9f7;
      border-radius: 10px;
      padding: 15px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      transition: transform 0.2s;
    }
    .film:hover {
      transform: translateY(-4px);
    }
    .film.watched {
      opacity: 0.6;
    }
    .film.watched p {
      text-decoration: line-through;
      color: #999;
    }
    .film.watched img {
      filter: grayscale(100%);
    }
    .hidden { display: none; }
    .readonly-note {
      font-size: 0.9rem;
      color: #888;
      margin-top: 10px;
    }
  </style>
</head>
<body>

<div class="container" id="loginBox">
  <h2>Connexion √† la Watchlist</h2>
  <div class="manual-login" id="manualLoginBox">
    <input type="email" id="manualEmail" placeholder="Entrez votre adresse e-mail"
      style="padding:10px; width:90%; max-width:400px; margin-bottom:10px; border-radius:6px; border:1px solid #ccc;">
    <br>
    <button type="button" onclick="launchGooglePrompt()">Se connecter avec Google</button>
  </div>
  <p>ou</p>
  <button onclick="enterAsGuest()">Continuer en tant qu'invit√©</button>
</div>

<div class="container hidden main-card" id="appBox">
  <h2>üé¨ Watchlist des Flammes Jum</h2>
  <p id="welcomeMessage"></p>
  <button onclick="logout()">Se d√©connecter</button>
  <div class="readonly-note" id="guestNote">Mode invit√© : lecture seule</div>

  <form id="filmForm" class="film-form" autocomplete="off">
    <input type="text" id="filmInput" placeholder="Titre du film..." required />
    <select id="addedBy" required>
      <option value="">Ajout√© par ?</option>
      <option value="Florine">Florine</option>
      <option value="Fabien">Fabien</option>
    </select>
    <textarea id="noteInput" placeholder="Note personnelle (facultatif)"></textarea>
    <button type="submit">Ajouter</button>
  </form>

  <select id="sortSelect">
    <option value="default">Tri par d√©faut</option>
    <option value="title">Titre</option>
    <option value="addedBy">Ajout√© par</option>
    <option value="watched">Vu / Non vu</option>
  </select>

  <div class="loader" id="loader">Chargement...</div>
  <div class="film-list" id="filmList"></div>
</div>

<script>
  let isGuest = false;
  const OMDB_API_KEY = 'd380a270';
  const ALLOWED_EMAILS = [
    "moutoussamy.florine@gmail.com",
    "fabien.ogli@gmail.com"
  ];
  let films = [];

  google.accounts.id.initialize({
    client_id: "753185542113-ec8b0nlbtn4li698ljrfq8g6mpdccap4.apps.googleusercontent.com",
    callback: handleCredentialResponse,
    ux_mode: "popup"
  });

  function handleCredentialResponse(response) {
    const user = parseJwt(response.credential);
    console.log("Utilisateur connect√© :", user);
    if (user && user.email) {
      if (!ALLOWED_EMAILS.includes(user.email)) {
        alert("‚ö†Ô∏è Cet e-mail n‚Äôest pas autoris√© √† acc√©der √† cette application.");
        return;
      }
      localStorage.setItem("authUser", JSON.stringify(user));
      localStorage.setItem("isGuest", "0");
      showApp(user.name || "Utilisateur");
    }
  }

  function parseJwt(token) {
    try {
      const base64Url = token.split('.')[1];
      const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
      const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
        return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
      }).join(''));
      return JSON.parse(jsonPayload);
    } catch (e) {
      return null;
    }
  }

  function enterAsGuest() {
    isGuest = true;
    localStorage.setItem("authUser", "guest");
    localStorage.setItem("isGuest", "1");
    showApp("Invit√©");
  }

  function logout() {
    localStorage.removeItem("authUser");
    localStorage.removeItem("isGuest");
    location.reload();
  }

  function showApp(name) {
    document.getElementById("loginBox").classList.add("hidden");
    document.getElementById("appBox").classList.remove("hidden");
    document.getElementById("welcomeMessage").textContent = "Bienvenue, " + name + " !";

    const guest = localStorage.getItem("isGuest") === "1";
    isGuest = guest;
    document.getElementById("guestNote").style.display = guest ? "block" : "none";

    if (guest) {
      const formElements = document.querySelectorAll('#filmForm input, #filmForm select, #filmForm textarea, #filmForm button');
      formElements.forEach(el => el.style.display = 'none');
    }

    loadFromLocal();
    displayFilms();
  }

  function displayFilms() {
    filmList.innerHTML = '';
    const sorted = [...films];
    switch (sortSelect.value) {
      case 'title':
        sorted.sort((a, b) => a.title.localeCompare(b.title));
        break;
      case 'addedBy':
        sorted.sort((a, b) => a.addedBy.localeCompare(b.addedBy));
        break;
      case 'watched':
        sorted.sort((a, b) => a.watched - b.watched);
        break;
    }

    sorted.forEach((film, index) => {
      const div = document.createElement('div');
      div.className = 'film' + (film.watched ? ' watched' : '');
      div.innerHTML = `
        ${film.poster ? `<img src="${film.poster}" alt="Affiche de ${film.title}" />` : ''}
        <p><strong>${film.title}</strong></p>
        <p>üé¨ R√©alis√© par : ${film.director || 'Inconnu'}</p>
        <p>üë§ Ajout√© par : ${film.addedBy}</p>
        ${film.note ? `<p>üìù ${film.note}</p>` : ''}
        ${!isGuest ? `
          <label><input type="checkbox" ${film.watched ? 'checked' : ''} onchange="toggleWatched(${index})" /> Vu</label>
          <button onclick="deleteFilm(${index})">Supprimer</button>` : ''}
      `;
      filmList.appendChild(div);
    });
  }

  function toggleWatched(index) {
    films[index].watched = !films[index].watched;
    saveToLocal();
    displayFilms();
  }

  function deleteFilm(index) {
    if (confirm('Supprimer ce film ?')) {
      films.splice(index, 1);
      saveToLocal();
      displayFilms();
    }
  }

  function saveToLocal() {
    localStorage.setItem("films", JSON.stringify(films));
  }

  function loadFromLocal() {
    const stored = localStorage.getItem("films");
    if (stored) films = JSON.parse(stored);
  }

  function launchGooglePrompt() {
    document.getElementById("manualLoginBox").style.display = "none";
    google.accounts.id.prompt();
  }

  window.onload = function () {
    const authUser = localStorage.getItem("authUser");
    const guest = localStorage.getItem("isGuest") === "1";
    if (authUser) {
      const name = guest ? "Invit√©" : JSON.parse(authUser).name || "Utilisateur";
      showApp(name);
    }
  }
</script>

</body>
</html>
